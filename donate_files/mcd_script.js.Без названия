mcdApi = {

	
	"previes": [{"previ_id":484262,"price":10,"title":"Staff","descr":"\/donate  <br \/>\n(\u0431\u0435\u0437 \u043a\u043e\u043c\u0438\u0441\u0441\u0438\u0438 \u043c\u043e\u0436\u043d\u043e \u043a\u0443\u043f\u0438\u0442\u044c \u0443 vk.com\/on3s228)","img_type":"","do_not_resize":0,"imageUrl":"http:\/\/mcdonate.ru\/static\/v2\/img\/default_previ.png"},{"previ_id":484251,"price":25,"title":"Elite","descr":"","img_type":"","do_not_resize":0,"imageUrl":"http:\/\/mcdonate.ru\/static\/v2\/img\/default_previ.png"},{"previ_id":484252,"price":35,"title":"Creative","descr":"","img_type":"","do_not_resize":0,"imageUrl":"http:\/\/mcdonate.ru\/static\/v2\/img\/default_previ.png"},{"previ_id":815397,"price":79,"title":"Luxury","descr":"","img_type":"","do_not_resize":0,"imageUrl":"http:\/\/mcdonate.ru\/static\/v2\/img\/default_previ.png"},{"previ_id":798730,"price":119,"title":"Ultra","descr":"","img_type":"","do_not_resize":0,"imageUrl":"http:\/\/mcdonate.ru\/static\/v2\/img\/default_previ.png"},{"previ_id":798733,"price":219,"title":"Emerald","descr":"","img_type":"","do_not_resize":0,"imageUrl":"http:\/\/mcdonate.ru\/static\/v2\/img\/default_previ.png"},{"previ_id":804990,"price":450,"title":"Support","descr":"","img_type":"","do_not_resize":0,"imageUrl":"http:\/\/mcdonate.ru\/static\/v2\/img\/default_previ.png"}],
	"srv": {"server_id":"82986","domain":"lcsrv","maxPlayers":0,"curPlayers":0},
	"callback": "",
	"container_id": "mcdApiContainer",
	"nickname": "",
	"beauty": 1,
	
	init: function(){
		console.log('MCD API Enabled (' +  mcdApi.srv.server_id + ')');
		
		

		if (mcdApi.callback.length > 3){

			eval('var fn = ' + mcdApi.callback + ';');
			fn.apply(null, [mcdApi.getInfo()]);		
			
		}
		
		if (mcdApi.container_id.length > 1){
			if (mcdApi.beauty){
				document.getElementById(mcdApi.container_id).setAttribute("class", 'beauty');
				document.getElementById(mcdApi.container_id).innerHTML = mcdApi.printInputBeauty();
				mcdApi.bindings();
			}
			else {
				document.getElementById(mcdApi.container_id).innerHTML = mcdApi.printInput();			
			}
		}


		
	},
	
	bindings: function(){
		var select = document.getElementById('MCDSelect');	
		var text = document.getElementById('MCDSelectText');

		select.onclick = function(e) {
			e.preventDefault();
			this.className = this.className.indexOf('MCDOpen') == -1 ? 'MCDOpen' : '';
			
			e = e || window.event;
			var el = e.target || e.srcElement;

			if(el.parentNode.id == 'MCDSelectDrop') {
				text.innerHTML = el.innerHTML;
				text.style.color = 'inherit';
				var spans = el.parentNode.getElementsByTagName('span');
				for(var i = 0; i < spans.length; i++)
				{
					spans[i].style.fontWeight = 'normal';
				}
				el.style.fontWeight = 'bold';
				console.log(el.getAttribute('previ_id'));
				this.setAttribute('previ_id', el.getAttribute('previ_id'));
				mcdApi.selectedPrevi = el.getAttribute('previ_id');
			}
		};
		
	},
	
	printInput: function(){
		var html = "<select class='mcdApiSelect'>";
		
		for (var i = 0 ; i < mcdApi.previes.length; i++){
			var item = mcdApi.previes[i];
			
			html += "<option previ_id='" + item.previ_id + "' price='" + item.price + "'>" + item.title + " (" + item.price + " руб.)</option>";
		}

		html += '</select><input type="button" class="mcdApiButton" value="Купить" onClick="mcdApi.doBuyPrevi(this);">';
		return html ;
	},
	
	printInputBeauty: function(){
		
		var preselect = '';
		var MCDSelectText = 'Выберите привилегию';
		
		if (mcdApi.previes.length == 1){
			mcdApi.selectedPrevi = mcdApi.previes[0].previ_id;
			preselect = 'previ_id="' + mcdApi.previes[0].previ_id + '"';
			MCDSelectText = '<span style="color: #555;">' + mcdApi.previes[0].title + " (" + mcdApi.previes[0].price + " руб.) </span>" ;
		}
		
		
		var html = '<div id="MCDTitle">Купить донат</div><input type="text" id="MCDnickname" class="MCDinput" placeholder="Ваш никнейм в игре"><div id="MCDSelect" ' + preselect + '><div id="MCDSelectContent"><div id="MCDSelectText">' + MCDSelectText + '</div><div id="MCDSelectDrop">';
		
		for (var i = 0 ; i < mcdApi.previes.length; i++){
			var item = mcdApi.previes[i];
			
			html += "<span previ_id='" + item.previ_id + "' price='" + item.price + "'>" + item.title + " (" + item.price + " руб.) </span> ";
		}

		html += '</div></div></div><div id="MCDbutton" onClick="mcdApi.setNickname(document.getElementById(\'MCDnickname\').value); mcdApi.buyPreviNative(mcdApi.selectedPrevi);">Продолжить</div>';
		return html ;
	},
	
	doBuyPrevi: function(_this){
		
		var select = _this.previousSibling  ;
		var option = select[select.selectedIndex];
		
		var previ_id = option.getAttribute('previ_id');
		
		mcdApi.buyPreviNative(previ_id);

	},
	
	buyPreviNative: function(previ_id){
		var url = 'http://' + mcdApi.srv.domain + '.mcdonate.ru';	
		
		url = url + '/performOrder2/?mcdApi&server_id=' + mcdApi.srv.server_id + '&previ_id=' + previ_id;
		
		if (mcdApi.nickname.length > 0){
			url += '&playerNickname=' + mcdApi.nickname;
		}
		
		document.location.href = url ;		
	},
	
	setNickname: function(nickname){
		mcdApi.nickname = nickname ;
	},
	
	getInfo: function(){
		var text = mcdApi.previes;
		
		return text; 
	},
};

function bindReady(handler){

	var called = false

	function ready() { // (1)
		if (called) return
		called = true
		handler()
	}

	if ( document.addEventListener ) { // (2)
		document.addEventListener( "DOMContentLoaded", function(){
			ready()
		}, false )
	} else if ( document.attachEvent ) {  // (3)

		// (3.1)
		if ( document.documentElement.doScroll && window == window.top ) {
			function tryScroll(){
				if (called) return
				if (!document.body) return
				try {
					document.documentElement.doScroll("left")
					ready()
				} catch(e) {
					setTimeout(tryScroll, 0)
				}
			}
			tryScroll()
		}

		// (3.2)
		document.attachEvent("onreadystatechange", function(){

			if ( document.readyState === "complete" ) {
				ready()
			}
		})
	}

	// (4)
    if (window.addEventListener)
        window.addEventListener('load', ready, false)
    else if (window.attachEvent)
        window.attachEvent('onload', ready)
    /*  else  // (4.1)
        window.onload=ready
	*/
}

readyList = []

function onReady(handler) {

	if (!readyList.length) {
		bindReady(function() {
			for(var i=0; i<readyList.length; i++) {
				readyList[i]()
			}
		})
	}

	readyList.push(handler)
}

onReady(function() {
	mcdApi.init();

	var url = 'https://mcdonate.ru/api/';
	var style = document.createElement('link');
	style.href = url + 'api_style.css';
	style.type = 'text/css';
	style.rel = 'stylesheet';
	document.getElementsByTagName('head')[0].appendChild(style);
});


